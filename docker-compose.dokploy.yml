# Docker Compose configuration for Dokploy deployment
# This file uses pre-built images from GitHub Container Registry
#
# ⚠️ SECURITY WARNING ⚠️
# This file contains insecure default values to allow containers to start.
# YOU MUST set proper values in Dokploy's Environment Variables UI:
# - DB_PASSWORD (currently uses insecure default: changeme_insecure_default)
# - WHATSAPP_API_URL (REQUIRED for functionality)
# - WHATSAPP_API_TOKEN or WHATSAPP_API_USER+PASSWORD (REQUIRED)
# - OPENAI_API_KEY or ANTHROPIC_API_KEY (REQUIRED)
#
# Dokploy will automatically:
# - Pull images from GHCR
# - Manage environment variables through its UI
# - Handle networking and SSL/TLS
# - Provide monitoring and logs
#
# Usage in Dokploy:
# 1. Create a new "Compose" application
# 2. Connect your GitHub repository
# 3. Select this file as the compose file
# 4. Set environment variables in Dokploy UI (REQUIRED!)
# 5. Deploy!

version: '3.8'

services:
  backend:
    image: ghcr.io/madpin/whatslang/backend:latest
    pull_policy: always
    restart: unless-stopped
    
    environment:
      # Database configuration
      DATABASE_URL: postgresql://${DB_USER:-whatslang}:${DB_PASSWORD:-changeme_insecure_default}@postgres:5432/${DB_NAME:-whatslang}
      
      # WhatsApp API configuration (REQUIRED)
      WHATSAPP_API_URL: ${WHATSAPP_API_URL:-https://CONFIGURE_YOUR_WHATSAPP_API_URL}
      WHATSAPP_API_TOKEN: ${WHATSAPP_API_TOKEN:-}
      WHATSAPP_PHONE_NUMBER_ID: ${WHATSAPP_PHONE_NUMBER_ID:-}
      
      # WhatsApp API Basic Auth (if using go-whatsapp-web-multidevice)
      WHATSAPP_API_USER: ${WHATSAPP_API_USER:-}
      WHATSAPP_API_PASSWORD: ${WHATSAPP_API_PASSWORD:-}
      
      # LLM configuration (at least one required)
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-https://api.openai.com/v1}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-5-mini}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      
      # Application settings
      DEBUG: ${DEBUG:-false}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      RELOAD: "false"
      
      # CORS settings (adjust for your domain)
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,https://yourdomain.com}
    
    depends_on:
      - postgres

  frontend:
    image: ghcr.io/madpin/whatslang/frontend:latest
    pull_policy: always
    restart: unless-stopped
    
    environment:
      # Backend URL for nginx proxy (internal docker network by default)
      # Override this in Dokploy UI if deploying services separately
      BACKEND_URL: ${BACKEND_URL:-backend:8000}
    
    depends_on:
      - backend

  postgres:
    image: postgres:15-alpine
    pull_policy: always
    restart: unless-stopped
    
    environment:
      POSTGRES_DB: ${DB_NAME:-whatslang}
      POSTGRES_USER: ${DB_USER:-whatslang}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme_insecure_default}
    
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
    driver: local
