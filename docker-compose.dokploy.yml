# Docker Compose configuration for Dokploy deployment
# This file uses pre-built images from GitHub Container Registry
#
# ⚠️ SECURITY WARNING ⚠️
# This file contains insecure default values to allow containers to start.
# YOU MUST set proper values in Dokploy's Environment Variables UI:
# - DB_PASSWORD (currently uses insecure default: changeme_insecure_default)
# - WHATSAPP_API_URL (REQUIRED for functionality)
# - WHATSAPP_API_TOKEN or WHATSAPP_API_USER+PASSWORD (REQUIRED)
# - OPENAI_API_KEY or ANTHROPIC_API_KEY (REQUIRED)
#
# Dokploy will automatically:
# - Pull images from GHCR
# - Manage environment variables through its UI
# - Handle networking and SSL/TLS
# - Provide monitoring and logs
#
# Usage in Dokploy:
# 1. Create a new "Compose" application
# 2. Connect your GitHub repository
# 3. Select this file as the compose file
# 4. Set environment variables in Dokploy UI (REQUIRED!)
# 5. Deploy!

version: '3.8'

services:
  backend:
    # Use pre-built image from GitHub Container Registry
    image: ghcr.io/madpin/whatslang/backend:latest
    # For specific version, use: ghcr.io/madpin/whatslang/backend:v1.0.0
    pull_policy: always
    
    restart: unless-stopped
    
    # ports:
    #   - "8000:8000"
    
    environment:
      # Database configuration
      DATABASE_URL: postgresql://${DB_USER:-whatslang}:${DB_PASSWORD:-changeme_insecure_default}@postgres:5432/${DB_NAME:-whatslang}
      
      # WhatsApp API configuration (REQUIRED)
      WHATSAPP_API_URL: ${WHATSAPP_API_URL:-https://CONFIGURE_YOUR_WHATSAPP_API_URL}
      WHATSAPP_API_TOKEN: ${WHATSAPP_API_TOKEN:-}
      WHATSAPP_PHONE_NUMBER_ID: ${WHATSAPP_PHONE_NUMBER_ID:-}
      
      # WhatsApp API Basic Auth (if using go-whatsapp-web-multidevice)
      WHATSAPP_API_USER: ${WHATSAPP_API_USER:-}
      WHATSAPP_API_PASSWORD: ${WHATSAPP_API_PASSWORD:-}
      
      # LLM configuration (at least one required)
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-https://api.openai.com/v1}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-5-mini}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      
      # Application settings
      DEBUG: ${DEBUG:-false}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      RELOAD: "false"
      
      # CORS settings (adjust for your domain)
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,https://yourdomain.com}
    
    depends_on:
      postgres:
        condition: service_healthy
      
    
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Resource limits for production
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  frontend:
    # Use pre-built image from GitHub Container Registry
    image: ghcr.io/madpin/whatslang/frontend:latest
    # For specific version, use: ghcr.io/madpin/whatslang/frontend:v1.0.0
    pull_policy: always
    
    restart: unless-stopped
    
    # ports:
    #   - "3000:80"
    
    depends_on:
      - backend
    
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    

  postgres:
    image: postgres:15-alpine
    pull_policy: always
    restart: unless-stopped
    
    environment:
      POSTGRES_DB: ${DB_NAME:-whatslang}
      POSTGRES_USER: ${DB_USER:-whatslang}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme_insecure_default}
      
      # Performance tuning for production
      POSTGRES_SHARED_BUFFERS: ${POSTGRES_SHARED_BUFFERS:-256MB}
      POSTGRES_EFFECTIVE_CACHE_SIZE: ${POSTGRES_EFFECTIVE_CACHE_SIZE:-1GB}
      POSTGRES_MAINTENANCE_WORK_MEM: ${POSTGRES_MAINTENANCE_WORK_MEM:-64MB}
      POSTGRES_CHECKPOINT_COMPLETION_TARGET: ${POSTGRES_CHECKPOINT_COMPLETION_TARGET:-0.9}
      POSTGRES_WAL_BUFFERS: ${POSTGRES_WAL_BUFFERS:-16MB}
      POSTGRES_DEFAULT_STATISTICS_TARGET: ${POSTGRES_DEFAULT_STATISTICS_TARGET:-100}
      POSTGRES_RANDOM_PAGE_COST: ${POSTGRES_RANDOM_PAGE_COST:-1.1}
      POSTGRES_EFFECTIVE_IO_CONCURRENCY: ${POSTGRES_EFFECTIVE_IO_CONCURRENCY:-200}
      POSTGRES_WORK_MEM: ${POSTGRES_WORK_MEM:-4MB}
      POSTGRES_MIN_WAL_SIZE: ${POSTGRES_MIN_WAL_SIZE:-1GB}
      POSTGRES_MAX_WAL_SIZE: ${POSTGRES_MAX_WAL_SIZE:-4GB}
    
    volumes:
      - postgres_data:/var/lib/postgresql/data
    
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-whatslang}"]
      interval: 10s
      timeout: 5s
      retries: 5
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

volumes:
  postgres_data:
    driver: local
